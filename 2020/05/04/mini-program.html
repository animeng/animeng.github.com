<!DOCTYPE html>
<html>
<head>
    <link rel="shortcut icon" href="">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>小程序移动端方案分享 </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="走自己的路，让别人说去吧">
    <meta name="author" content="mengtnt">
    <meta name="keywords" content="">
    <link rel="canonical" href="https://mengtnt.com/2020/05/04/mini-program.html">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/pixyll.css" type="text/css">

    <!-- Fonts -->
    <!-- <link href='//fonts.useso.com/css?family=Merriweather:900,900italic,300,300italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.useso.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'> -->
    
      <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    

    <!-- Open Graph -->
    <!-- From: https://github.com/mmistakes/hpstr-jekyll-theme/blob/master/_includes/head.html -->
    <meta property="og:locale" content="en_US">
    <meta property="og:type" content="article">
    <meta property="og:title" content="小程序移动端方案分享">
    <meta property="og:description" content="走自己的路，让别人说去吧">
    <meta property="og:url" content="https://mengtnt.com/2020/05/04/mini-program.html">
    <meta property="og:site_name" content="mengtnt的Blog">
    

</head>

<body class="">
  <div class="site-wrap">
    <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="https://mengtnt.com" class="site-title">mengtnt的Blog</a>
      <nav class="site-nav right">
        <a href="/about/">关于</a>
<a href="/contact/">联系</a>

      </nav>
      <div class="clearfix"></div>
      
        <div class="social-icons">
  <div class="left">
    
      <a class="fa fa-github" href="https://github.com/animeng"></a>
    
    
      <a class="fa fa-twitter" href="https://twitter.com/mengtnt"></a>
    
    
      <a class="social fa fa-weibo" href="https://weibo.com/mengtnt"></a>
    
    
    
      <a class="fa fa-envelope" href="mailto:animeng68@gmail.com"></a>
    
    
  </div>
  <div class="right">
    
    
    
  </div>
</div>
<div class="clearfix"></div>

      
    </div>
  </div>
</header>


    <div class="post p2 p-responsive wrap" role="main">
      <div class="measure">
        


<div class="post-header mb2">
  
  <h1 class="py2">小程序移动端方案分享</h1>
  
  <span class="post-meta">05月 04日, 2020</span><br>
  
  <span class="post-meta small">11 minute read</span>
</div>

<article class="post-content">
  <p>前端时间有朋友咨询如何实现一个小程序的框架，可以方便的集成到自己的应用中，方便之后前端更新UI。之前自己曾经调研过小程序的技术原理，这里分享这篇博客目的是对小程序移动端的方案进行一些实践。下面就分享下小程序移动端的实践。首先看下小程序整体的一张架构图。</p>

<p><img src="/images/mini-program-1.png" alt="小程序架构图.png" /></p>

<p>其实小程序的核心思想还是逻辑层和渲染层分离，这样Native可以把逻辑层的代码放到一个单独的线程中，渲染层只负责页面的展示，从而提高了Webview上显示的效率。所以Native的开发核心就是约定逻辑层和渲染层同上层前端代码的协议。</p>

<h2 id="小程序源码的分析">小程序源码的分析</h2>

<p>首先可以看下微信小程序的IDE工具:</p>

<p><img src="/images/mini-program-2.png" alt="微信小程序.png" /></p>

<p>微信小程序的IDE工具主要是基于<a href="https://nwjs.io/">NW</a>开源框架开发的，我们这里主要是基于<a href="https://electronjs.org/">electron</a>这个web技术构建桌面应用框架，写的小程序IDE的demo。其实本质上两个框架是大同小异的。下面看下百度开源的小程序IDE工具的大致架构图:</p>

<p><img src="/images/mini-program-3.png" alt="百度小程序IED.png" /></p>

<p><img src="/images/mini-program-4.png" alt="小程序IDE.png" /></p>

<p>基于上面的框架，构建了小程序IDE示例程序，demo的源码目录结构如下:
<img src="/images/mini-program-5.png" alt="IDE目录.png" /></p>

<p>开发者主要是在app目录下开发，基于vue的模版语法进行页面编写，这个demo示例主要有index.cloud、index.css、index.js文件。
index.cloud代码如下:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nt">&lt;page</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h1&gt;</span>hello<span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;p&gt;</span>!<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;button</span> <span class="err">@</span><span class="na">click=</span><span class="s">"say"</span><span class="nt">&gt;</span>666666<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">:value=</span><span class="s">"content"</span> <span class="err">@</span><span class="na">change=</span><span class="s">"handleInputChange"</span><span class="nt">&gt;&lt;/input&gt;</span>
    <span class="nt">&lt;p&gt;&lt;/p&gt;</span>

    <span class="nt">&lt;button</span> <span class="err">@</span><span class="na">click=</span><span class="s">"go"</span><span class="nt">&gt;</span>page 2!<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/page&gt;</span>

</code></pre></div></div>

<p>index.css代码如下:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nc">.container</span><span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100vw</span><span class="p">;</span>
    <span class="nl">height</span><span class="p">:</span> <span class="m">100vh</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">20px</span><span class="p">;</span>
    <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
    <span class="nl">flex-direction</span><span class="p">:</span> <span class="n">column</span><span class="p">;</span>
    <span class="nl">align-items</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
    <span class="nl">justify-content</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
    <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">button</span><span class="p">{</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">15px</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">18px</span><span class="p">;</span>
    <span class="nl">background</span><span class="p">:</span> <span class="no">black</span><span class="p">;</span>
    <span class="nl">color</span><span class="p">:</span> <span class="no">white</span><span class="p">;</span>
    <span class="nl">font-weight</span><span class="p">:</span> <span class="m">900</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">input</span><span class="p">{</span>
    <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span>
    <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
    <span class="nl">padding</span><span class="p">:</span> <span class="m">15px</span><span class="p">;</span>
    <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
    <span class="nl">font-size</span><span class="p">:</span> <span class="m">18px</span><span class="p">;</span>
    <span class="nl">font-weight</span><span class="p">:</span> <span class="m">900</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>index.js代码如下:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">Page</span><span class="p">({</span>
    <span class="nx">data</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">who</span><span class="p">:</span> <span class="dl">'</span><span class="s1">xxxx</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">what</span><span class="p">:</span> <span class="dl">'</span><span class="s1">uuu</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">content</span><span class="p">:</span> <span class="dl">'</span><span class="s1">empty!</span><span class="dl">'</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="na">watch</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">who</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">val</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ppppp</span><span class="dl">'</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">what</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">nnn</span><span class="dl">'</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">val</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">aaaa</span><span class="dl">'</span><span class="p">){</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">what</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ananana</span><span class="dl">'</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">mounted</span><span class="p">(){</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">who</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">ppppp</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="na">methods</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">say</span><span class="p">(){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">who</span><span class="dl">'</span><span class="p">,</span>  <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mi">36</span><span class="p">).</span><span class="nx">substring</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">));</span>
        <span class="p">},</span>
        <span class="nx">go</span><span class="p">(){</span>
            <span class="nx">beacon</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">(</span><span class="dl">'</span><span class="s1">page2</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">content</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="na">b</span><span class="p">:</span> <span class="mi">3</span> <span class="p">})</span>
        <span class="p">},</span>
        <span class="nx">handleInputChange</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setData</span><span class="p">(</span><span class="dl">'</span><span class="s1">content</span><span class="dl">'</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">})</span>

</code></pre></div></div>

<p>然后小程序通过master来解析用户的逻辑代码，生成数据，通过setData的方式传递给小程序slave的渲染层，这个传递的过程在IDE中是通过调用simulator层来模拟的，其实放到客户端的话，就是客户端需要实现的逻辑层js的运行环境。由于百度开源的小程序，移动端的逻辑并没有开放，所以我们根据百度小程序IDE开源的实现，做了一些分析，实现了移动端native的代码逻辑。下面我们就结合我们移动端的demo来看下具体的实现。</p>

<h2 id="ios小程序sdk的实现">ios小程序sdk的实现</h2>

<p>首先我们先看下上面的IDE中main.js中注册的一些模拟器方法</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nx">slave</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">page</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">ready</span><span class="p">(...</span><span class="nx">payload</span><span class="p">){</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">payload</span><span class="p">)</span>
            <span class="nx">schemas</span><span class="p">.</span><span class="nx">simulator</span><span class="p">.</span><span class="nx">webview</span><span class="p">.</span><span class="nx">distributeMessage</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="p">...</span><span class="nx">payload</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nx">setData</span><span class="p">(...</span><span class="nx">payload</span><span class="p">){</span>
            <span class="nx">schemas</span><span class="p">.</span><span class="nx">simulator</span><span class="p">.</span><span class="nx">webview</span><span class="p">.</span><span class="nx">distributeMessage</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="p">...</span><span class="nx">payload</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="nx">master</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">page</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">startListen</span><span class="p">(){</span>
            <span class="nx">schemas</span><span class="p">.</span><span class="nx">native</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">navigateTo</span><span class="p">(</span><span class="dl">'</span><span class="s1">native/page/navigateTo</span><span class="dl">'</span><span class="p">,</span> <span class="nx">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">slaveLocations</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="nx">master</span><span class="p">.</span><span class="nx">openDevTools</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="nx">hook</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="p">...</span><span class="nx">payload</span><span class="p">){</span>
            <span class="nx">master</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">currPage</span><span class="p">,</span> <span class="p">...</span><span class="nx">payload</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nx">callFn</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="p">...</span><span class="nx">payload</span><span class="p">){</span>
            <span class="nx">master</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">currPage</span><span class="p">,</span> <span class="p">...</span><span class="nx">payload</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nx">prepare</span><span class="p">(</span><span class="nx">schema</span><span class="p">){</span>
            <span class="c1">// 准备页面</span>
            <span class="nx">master</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">currPage</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">destroy</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">page</span><span class="p">)</span>
            <span class="nx">master</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">page</span><span class="p">);</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">},</span>
<span class="nx">native</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">page</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">navigateTo</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">payload</span><span class="p">){</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`navigateTo </span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
            <span class="c1">// 获取页面的对象序号，修改当前集中的页面到序号页面</span>
            <span class="nx">currPage</span> <span class="o">=</span> <span class="nx">routes</span><span class="p">.</span><span class="nx">findIndex</span><span class="p">((</span><span class="nx">p</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">p</span> <span class="o">===</span> <span class="nx">url</span><span class="p">);</span>
            <span class="c1">// 创建 webview ，获取 webviewid</span>
            <span class="kd">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">payload</span> <span class="o">&amp;&amp;</span> <span class="nx">queryString</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">host</span><span class="p">}${</span><span class="nx">url</span><span class="p">}</span><span class="s2">.html</span><span class="p">${</span><span class="nx">query</span> <span class="p">?</span> <span class="s2">`?</span><span class="p">${</span><span class="nx">query</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span><span class="dl">''</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`navigateTo </span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
            <span class="nx">schemas</span><span class="p">.</span><span class="nx">simulator</span><span class="p">.</span><span class="nx">webview</span><span class="p">.</span><span class="nx">createWebview</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">currPage</span><span class="p">);</span>
            <span class="c1">// 压入页面栈</span>
            <span class="nx">push</span><span class="p">({</span>
                <span class="na">pageIndex</span><span class="p">:</span> <span class="nx">currPage</span><span class="p">,</span>
                <span class="na">path</span><span class="p">:</span> <span class="nx">routes</span><span class="p">[</span><span class="nx">url</span><span class="p">],</span>
                <span class="nx">location</span><span class="p">,</span>
                <span class="na">query</span><span class="p">:</span> <span class="nx">payload</span>
                <span class="c1">// page</span>
            <span class="p">})</span>
        <span class="p">},</span>
        <span class="nx">navigateBack</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">payload</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">isBottom</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
            <span class="nx">schemas</span><span class="p">.</span><span class="nx">master</span><span class="p">.</span><span class="nx">page</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="dl">'</span><span class="s1">master/page/destroy</span><span class="dl">'</span><span class="p">,</span> <span class="nx">currPage</span><span class="p">);</span>
            <span class="nx">schemas</span><span class="p">.</span><span class="nx">simulator</span><span class="p">.</span><span class="nx">webview</span><span class="p">.</span><span class="nx">destroyWebview</span><span class="p">(</span><span class="nx">currPage</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">curr</span> <span class="o">=</span> <span class="nx">pop</span><span class="p">();</span>
            <span class="nx">currPage</span> <span class="o">=</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">pageIndex</span><span class="p">;</span>

        <span class="p">},</span>
        <span class="nx">getQuery</span><span class="p">(</span><span class="nx">schema</span><span class="p">){</span>
            <span class="nx">master</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">simulator</span><span class="dl">'</span><span class="p">,</span> <span class="nx">schema</span><span class="p">,</span> <span class="nx">currPage</span><span class="p">,</span> <span class="nx">getCurrentCache</span><span class="p">().</span><span class="nx">query</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">},</span>
<span class="nx">app</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">onLaunch</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">options</span><span class="p">){</span>

        <span class="p">},</span>
        <span class="nx">onShow</span><span class="p">(</span><span class="nx">schema</span><span class="p">,</span> <span class="nx">options</span><span class="p">){</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>下面我分析下移动端如何配合前端代码，来实现最终渲染的。首先看下ios端小程序sdk的代码目录结构:</p>

<p><img src="/images/mini-program-6.png" alt="ios目录结构.png" /></p>

<p>ios的逻辑层代码是基于JSContext实现，渲染层是基于WKWebview实现。jscontext层的核心代码是实现下面的协议:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">^</span><span class="kt">JSCallBack</span><span class="p">)(</span><span class="kt">NSString</span> <span class="o">*</span> <span class="n">schema</span><span class="p">,</span><span class="n">id</span> <span class="n">args</span><span class="p">);</span>

<span class="kd">@protocol</span> <span class="kt">NEBridgeProtocol</span> <span class="o">&lt;</span><span class="kt">NSObject</span><span class="o">&gt;</span>

<span class="kd">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="kt">JSValue</span><span class="o">*</span> <span class="n">exception</span><span class="p">;</span>

<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">evalJavascript</span><span class="p">:(</span><span class="kt">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">script</span><span class="p">;</span>

<span class="o">-</span> <span class="p">(</span><span class="kt">JSValue</span> <span class="o">*</span><span class="p">)</span><span class="nv">callJSMethod</span><span class="p">:(</span><span class="kt">NSString</span><span class="o">*</span><span class="p">)</span><span class="n">method</span> <span class="nv">args</span><span class="p">:(</span><span class="kt">NSArray</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">;</span>

<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">listenJSEvent</span><span class="p">:(</span><span class="kt">NSString</span><span class="o">*</span><span class="p">)</span><span class="n">name</span> <span class="nv">callback</span><span class="p">:(</span><span class="kt">JSCallBack</span><span class="p">)</span><span class="n">callback</span><span class="p">;</span>

<span class="kd">@end</span>

</code></pre></div></div>

<p>上面的代码是逻辑层和前端代码沟通的核心，等下我会配合刚才IDE的业务代码分析下如何通信的。</p>

<p>渲染端的核心代码如下:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@protocol</span> <span class="kt">NEWebViewBridgeProtocol</span>

<span class="kd">@required</span>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">receiveMessageHandler</span><span class="p">:(</span><span class="nf">void</span> <span class="p">(</span><span class="o">^</span> <span class="n">_Nullable</span><span class="p">)(</span><span class="kt">WKScriptMessage</span> <span class="o">*</span> <span class="n">_Nonnull</span> <span class="n">message</span><span class="p">))</span><span class="n">completionHandler</span><span class="p">;</span>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">evaluateJavaScript</span><span class="p">:(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">_Nullable</span><span class="p">)</span><span class="n">javaScriptString</span><span class="p">;</span>

<span class="kd">@end</span>
</code></pre></div></div>

<h2 id="客户端如何同前端通信">客户端如何同前端通信</h2>

<p>有了前面基础理论的铺垫之后，我们来看下前端如何同客户端通信的，首先我们需要把逻辑层，也就是JSContext的运行环境放到一个单独的线程中,下面我贴出来一部分核心代码:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">runJSCode</span><span class="p">:(</span><span class="kt">NSString</span><span class="o">*</span><span class="p">)</span><span class="n">code</span> <span class="p">{</span>
    <span class="kd">@weakify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="nf">dispatch_async</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">threadQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
        <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">jsBridge</span> <span class="nv">evalJavascript</span><span class="p">:</span><span class="n">code</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">registerEvent</span><span class="p">:(</span><span class="kt">NSString</span><span class="o">*</span><span class="p">)</span><span class="n">name</span> <span class="nv">callback</span><span class="p">:(</span><span class="kt">JSCallBack</span><span class="p">)</span><span class="n">block</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">jsBridge</span> <span class="nv">listenJSEvent</span><span class="p">:</span><span class="n">name</span> <span class="nv">callback</span><span class="p">:</span><span class="n">block</span><span class="p">];</span>
<span class="p">}</span>

</code></pre></div></div>

<p>然后就是注册逻辑层的监听事件，相当于模拟electron工程的simulater的实现。</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">NEBridgeContext</span> <span class="o">*</span> <span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NEBridgeContext</span> <span class="nv">createInstance</span><span class="p">:</span><span class="s">@"netease"</span><span class="p">];</span>
<span class="kt">NSString</span> <span class="o">*</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[[</span><span class="kt">NSString</span> <span class="n">alloc</span><span class="p">]</span> <span class="nv">initWithContentsOfFile</span><span class="p">:</span><span class="n">path</span> <span class="nv">encoding</span><span class="p">:</span><span class="kt">NSUTF8StringEncoding</span> <span class="nv">error</span><span class="p">:</span><span class="kt">NULL</span><span class="p">];</span>
<span class="kd">@weakify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
<span class="p">[</span><span class="n">context</span> <span class="nv">registerEvent</span><span class="p">:</span><span class="s">@"startListen"</span> <span class="nv">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span><span class="kt">NSDictionary</span> <span class="o">*</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="nf">dispatch_async</span><span class="p">(</span><span class="nf">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="p">[</span><span class="k">self</span> <span class="n">createWebview</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}];</span>
<span class="p">[</span><span class="n">context</span> <span class="nv">registerEvent</span><span class="p">:</span><span class="s">@"navigateBack"</span> <span class="nv">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span><span class="kt">NSDictionary</span> <span class="o">*</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="nf">dispatch_async</span><span class="p">(</span><span class="nf">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">navigationController</span> <span class="nv">popViewControllerAnimated</span><span class="p">:</span><span class="kt">YES</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}];</span> 
<span class="p">[</span><span class="n">context</span> <span class="nv">registerEvent</span><span class="p">:</span><span class="s">@"navigateTo"</span> <span class="nv">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span><span class="n">id</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">args</span> <span class="nv">isKindOfClass</span><span class="p">:[</span><span class="kt">NSArray</span> <span class="kd">class</span><span class="p">]])</span> <span class="p">{</span>
        <span class="kt">NSArray</span> <span class="o">*</span> <span class="n">paras</span> <span class="o">=</span> <span class="p">(</span><span class="kt">NSArray</span><span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="p">;</span>
        <span class="k">self</span><span class="o">.</span><span class="n">queryData</span> <span class="o">=</span> <span class="n">paras</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nf">dispatch_async</span><span class="p">(</span><span class="nf">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
            <span class="p">[</span><span class="k">self</span> <span class="nv">navigationTo</span><span class="p">:</span><span class="n">paras</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}];</span>
<span class="p">[</span><span class="n">context</span> <span class="nv">registerEvent</span><span class="p">:</span><span class="s">@"setData"</span> <span class="nv">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span> <span class="n">id</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="p">[</span><span class="k">self</span> <span class="nv">handleSchema</span><span class="p">:</span><span class="n">schema</span> <span class="nv">args</span><span class="p">:</span><span class="n">args</span><span class="p">];</span>
<span class="p">}];</span>
<span class="p">[</span><span class="n">context</span> <span class="nv">registerEvent</span><span class="p">:</span><span class="s">@"ready"</span> <span class="nv">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span><span class="n">id</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
    <span class="p">[</span><span class="k">self</span> <span class="nv">handleSchema</span><span class="p">:</span><span class="n">schema</span> <span class="nv">args</span><span class="p">:</span><span class="n">args</span><span class="p">];</span>
<span class="p">}];</span> 
<span class="p">[</span><span class="n">context</span> <span class="nv">registerEvent</span><span class="p">:</span><span class="s">@"getQuery"</span> <span class="nv">callback</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">NSString</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span> <span class="n">id</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">dispatch_async</span><span class="p">(</span><span class="nf">dispatch_get_main_queue</span><span class="p">(),</span> <span class="o">^</span><span class="p">{</span>
        <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Logic excute : %@"</span><span class="p">,</span><span class="n">code</span><span class="p">);</span>
        <span class="p">[</span><span class="n">context</span> <span class="nv">runJSCode</span><span class="p">:</span><span class="n">code</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}];</span> 
<span class="p">[</span><span class="n">context</span> <span class="nv">runJSCode</span><span class="p">:</span><span class="n">code</span><span class="p">];</span>

</code></pre></div></div>

<p>其实上面的逻辑就是刚才提到的master做的主要事情。接收逻辑层的数据，然后通知客户端来创建webview，以及做一些native的控件和动画。之后进入到渲染层的处理，渲染层的代码逻辑如下:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="p">[</span><span class="k">self</span><span class="o">.</span><span class="n">mpView</span> <span class="nv">receiveMessageHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">WKScriptMessage</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">@strongify</span><span class="p">(</span><span class="k">self</span><span class="p">);</span>
        <span class="p">[</span><span class="k">self</span> <span class="nv">receiveRenderMessage</span><span class="p">:</span><span class="n">message</span> <span class="nv">webView</span><span class="p">:</span><span class="k">self</span><span class="o">.</span><span class="n">mpView</span><span class="p">];</span>
<span class="p">}];</span>

<span class="o">-</span> <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="nv">receiveRenderMessage</span><span class="p">:(</span><span class="kt">WKScriptMessage</span> <span class="o">*</span><span class="p">)</span> <span class="n">message</span> <span class="nv">webView</span><span class="p">:(</span><span class="kt">MNPWebView</span> <span class="o">*</span><span class="p">)</span> <span class="n">currentWebView</span> <span class="p">{</span>
    <span class="kt">NSArray</span> <span class="o">*</span> <span class="n">postMessages</span> <span class="o">=</span> <span class="p">(</span><span class="kt">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">;</span>
    <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Render message: %@"</span><span class="p">,</span><span class="n">postMessages</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">postMessages</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">NSString</span> <span class="o">*</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSString</span> <span class="nv">stringWithFormat</span><span class="p">:</span><span class="s">@"communicator.emit("</span><span class="p">];</span>
    <span class="kt">NSInteger</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="n">para</span> <span class="k">in</span> <span class="n">postMessages</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSString</span> <span class="nv">stringWithFormat</span><span class="p">:</span><span class="s">@"%@</span><span class="se">\"</span><span class="s">%@</span><span class="se">\"</span><span class="s">,%ld"</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="n">para</span><span class="p">,(</span><span class="n">long</span><span class="p">)</span><span class="n">currentWebView</span><span class="o">.</span><span class="n">pageIndex</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSString</span> <span class="nv">stringWithFormat</span><span class="p">:</span><span class="s">@"%@,</span><span class="se">\"</span><span class="s">%@</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span><span class="n">code</span><span class="p">,</span><span class="n">para</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">index</span> <span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NSString</span> <span class="nv">stringWithFormat</span><span class="p">:</span><span class="s">@"%@)"</span><span class="p">,</span><span class="n">code</span><span class="p">];</span>
    <span class="kt">NEBridgeContext</span> <span class="o">*</span> <span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="kt">NEBridgeContext</span> <span class="nv">createInstance</span><span class="p">:</span><span class="s">@"netease"</span><span class="p">];</span>
    <span class="kt">NSLog</span><span class="p">(</span><span class="s">@"Logic excute:%@"</span><span class="p">,</span><span class="n">code</span><span class="p">);</span>
    <span class="p">[</span><span class="n">context</span> <span class="nv">runJSCode</span><span class="p">:</span><span class="n">code</span><span class="p">];</span>
<span class="p">}</span>

</code></pre></div></div>

<p>渲染层主要是接收一些用户触发的事件，然后告诉逻辑层来获得数据，逻辑层准备完毕数据后，就再给渲染层，渲染层来渲染页面，最终显示出来。
至此客户端就把逻辑层和渲染层代码分离开了，可以分别的处理不同的事情。下面我们就看下demo的效果。</p>

<h2 id="ide环境和小程序的demo">IDE环境和小程序的Demo</h2>

<p>小程序的IDE其实是基于Electron的工程，我们需要启动Electron的模拟器和调试器，用户是通过编写VUE的模版代码和js代码来创建小程序的。如果说要实现客户端动态调试的话，其实是需要客户端创建websocket的连接，前端代码更新的时候，实时通知客户端进行渲染加载，目前demo还没有做这个事情，只是简单的分离了逻辑层和渲染层。下面我们看下我们demo的IDE的长的样子吧。</p>

<p>首先我们通过如下命令</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>simulator-shell/
node launch
</code></pre></div></div>

<p>启动模拟器的IDE环境，然后进到工程目录中启动当前小程序代码</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm run dev
</code></pre></div></div>

<p>结果如下图:</p>

<p><img src="/images/mini-program-7.png" alt="模拟器.png" /></p>

<p>小程序demo在编写完毕的时候，通过webpack打包输出master.js、page.js、index.html这些文件。然后客户端分别加载逻辑层master.js的代码和渲染层index.html运行这个demo。</p>

<h2 id="小程序完整方案">小程序完整方案</h2>

<p>逻辑层和渲染层分离只是小程序的一个核心功能，如果要做出来一个完成的小程序，当然还需要很多工程化的事情。这里就说下完整的方案需要的技术能力.</p>

<ol>
  <li>
    <p>Web资源离线缓存能力，小程序往往有大量的静态资源比如webpack打包好的渲染层的代码，以及图片音视频资源，这些如果能做离线缓存，就可以大大提升小程序的性能。</p>
  </li>
  <li>
    <p>静态资源更新的能力，这个就涉及到小程序更新的逻辑。由于静态资源远程加载一般都需要CDN来做加速，CDN节点往往都有资源缓存，所以对静态资源如何做更新哪？一般通用的方法时，更新静态资源版本号的方式，或者对资源做差量计算。这就要根据具体采用的方案进行细化了。</p>
  </li>
  <li>
    <p>小程序的远程调试能力。小程序开发者使用开发工具完成开发后，需要有一定的能力预览上线后的样式，然后可以远程调试定位问题。这里往往需要提供websocket的能力给开发者方便定位问题。</p>
  </li>
  <li>
    <p>native拓展能力，如果开发者，想要用native的代码做一些自定义动画，或者一些自定义控件的话，如果小程序可以方便的把一些native的控件和动画作为插件，集成到小程序的UI库中的话，就可以大大提升小程序的拓展能力。</p>
  </li>
  <li>
    <p>对一些JS语法能力的一些拓展。</p>
  </li>
</ol>

<h2 id="小程序前景展望">小程序前景展望</h2>

<p>小程序的重要一点就是可以做到实时发布一些功能。尤其对一些轻量级的页面，比如一些活动页面特别的有用。同时小程序又能让开发者使用一些native的功能，让用户体验上接近native。其实对于很多第三方的app都有开发自己小程序的需求，如果说能够开放出来一个小程序的生态环境，相信会吸引很多开发者入住。目前w3c已经提出了<a href="https://www.w3.org/TR/2019/WD-mini-app-white-paper-20190912/">小程序草案</a>。也是希望小程序有一个统一的标准，能更好的的服务广大的开发者。</p>

<p>当然我上面的分析只是针对小程序移动端sdk的一个笼统的介绍，如果需要做一个完善的小程序产品，还需要大量工程化的事情，比如我们要有大量的vue组件库和native的组件库，提供给开发者使用。IDE开发工具肯定也要做一些个性化的更改，比如热更新和调试功能。整个工程下来，可能并不像我这篇文章描述的这么简单，我这里只是分析了下目前小程序可行的一种方案。在技术方案可行的前提下，其实后期就是人力投入和产品打磨的过程了。往往一个成功的产品可能后期的打磨会更关键一些。也想借助这篇博客抛砖引玉，希望能够引起大家对小程序这个产品的兴趣。</p>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="https://github.com/swan-team">百度智能小程序</a></li>
</ul>

</article>





<div class="pay" align="center">
  <h3 style="color:#4DD0E1;">如果你喜欢这篇文章，谢谢你的赞赏</h3>
  <img src="https://cdn.jsdelivr.net/gh/animeng/animeng.github.com/images/pay-me.jpeg" alt="图3" style="width:400px;">
  <p>
    如有疑问<a href="/contact/">请联系我</a>
  </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.0/dist/mermaid.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script>  
$(document).ready(function () {
  window.mermaid.initialize({
    startOnLoad: true,
    theme: "default",
  });
  window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'));
});
</script>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/css/comment.css">
<script src="https://cdn.jsdelivr.net/gh/animeng/animeng.github.com/resource/gitment.browser.v1.js"></script>
<script>
var gitment = new Gitment({
    owner: 'animeng',
    repo: 'animeng.github.com',
    oauth: {
        client_id: 'Iv1.e26fdd0d45ec4f26',
        client_secret: '8d51965f69de8e300a42e151437b944f7cccf819',
    },
});
gitment.render('gitmentContainer');
</script>

		
	

      	
      </div>
    </div>
  </div>

  <footer class="footer">
  <div class="p2 wrap">
    <div class="measure mt1 center">
      <small>
	<a>© 2020 Mengtnt </a> 
  <a class="fa fa-rss" href="/feed.xml"></a>
  <br>
  <span>
    Site powered by <a href="https://jekyllrb.com/">Jekyll</a> &amp; <a href="https://pages.github.com/">Github Pages</a>.
  </span>
    </div>
  </div>
</footer>



</body>
</html>
